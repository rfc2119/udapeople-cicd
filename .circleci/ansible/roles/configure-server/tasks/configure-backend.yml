- name: checking env vars
  command: echo $ENVIRONMENT $TYPEORM_USERNAME $TYPEORM_PASSWORD $TYPEORM_HOST
- name: add nodejs repo to apt sources
  command:
    cmd: curl -O -fsSL https://deb.nodesource.com/setup_14.x
    creates: setup_14.x
- name: run the setup script
  become: true
  command: bash setup_14.x
- name: install with apt
  become: true
  apt:
    name: nodejs
- name: install pm2
  become: true
  community.general.npm:
    name: pm2
    global: true
- name: cloning the repository
  command:
    chdir: git
    cmd: 'git clone https://github.com/staticnotdynamic/udapeople-cicd'
- name: install nodejs dependencies for backend
  command:
    chdir: git/udapeople-cicd/backend
    cmd: npm i
- name: build backend
  command:
    chdir: git/udapeople-cicd/backend
    cmd: npm run build
- name: start production server
  command:
    chdir: git/udapeople-cicd/backend
    cmd: npm run start:prod

